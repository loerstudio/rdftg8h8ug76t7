<!DOCTYPE html>
<html lang="it"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Workout</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<!-- Supabase and Auth Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./js/supabaseClient.js"></script>
<script src="./js/auth.js"></script>
<script src="./js/api.js"></script>
<style type="text/tailwindcss">
    body {
      background-color: #000;
      color: #fff;
      font-family: 'Inter', sans-serif;
    }
    .tab-active {
      @apply border-b-2 border-red-500 text-white;
    }
    .tab-inactive {
      @apply text-gray-500;
    }
    .details-hidden {
        display: none;
    }
  </style>
<style>
    body {
      min-height: max(884px, 100dvh);
    }
  </style>
  </head>
<body class="pb-20">
<div class="p-4">
<div class="flex justify-between items-center mb-6">
<h1 class="text-3xl font-bold">Workout</h1>
<div class="flex space-x-3">
<button class="bg-gray-800 p-2 rounded-full">
<span class="material-icons">search</span>
</button>
<button class="bg-gray-800 p-2 rounded-full">
<span class="material-icons">calendar_today</span>
</button>
</div>
</div>
<div class="flex border-b border-gray-700 mb-6">
<button class="flex-1 py-2 text-center tab-active font-semibold">Programmi</button>
<button class="flex-1 py-2 text-center tab-inactive">Esercizi</button>
<button class="flex-1 py-2 text-center tab-inactive">Cronologia</button>
</div>
<button class="w-full bg-red-500 text-white font-bold py-4 rounded-lg flex items-center justify-center space-x-2 mb-6">
<span class="material-icons">sensors</span>
<span>Live Workout</span>
</button>
<h2 class="text-xl font-semibold mb-4">I Miei Programmi</h2>
<div class="space-y-4" id="program-container">
    <p id="loading-program">Caricamento del programma in corso...</p>
    <!-- Program will be dynamically inserted here -->
</div>
</div>
<div class="fixed bottom-0 left-0 right-0 bg-black border-t border-gray-700 flex justify-around items-center py-2">
<a class="text-center text-gray-400" href="#">
<span class="material-icons">home</span>
<span class="block text-xs">Home</span>
</a>
<a class="text-center text-red-500 border-t-2 border-red-500 px-4 pt-2" href="#">
<span class="material-icons">fitness_center</span>
<span class="block text-xs">Workout</span>
</a>
<a class="text-center text-gray-400" href="#">
<span class="material-icons">restaurant</span>
<span class="block text-xs">Alimentazione</span>
</a>
<a class="text-center text-gray-400" href="#">
<span class="material-icons">trending_up</span>
<span class="block text-xs">Progressi</span>
</a>
<a class="text-center text-gray-400" href="#">
<span class="material-icons">chat</span>
<span class="block text-xs">Chat</span>
</a>
</div>

<script>
    const programContainer = document.getElementById('program-container');
    const loadingElement = document.getElementById('loading-program');

    function renderProgram(program) {
        programContainer.innerHTML = ''; // Clear loading message
        if (!program) {
            programContainer.innerHTML = '<p class="text-gray-400">Nessun programma di allenamento assegnato.</p>';
            return;
        }

        const programDiv = document.createElement('div');
        programDiv.className = 'bg-gray-900 rounded-lg';

        let daysHtml = '';
        program.training_days.forEach(day => {
            let exercisesHtml = '';
            day.program_exercises.forEach(pe => {
                exercisesHtml += `
                    <div class="ml-4 pl-4 border-l border-gray-700 py-2">
                        <p class="font-semibold">${pe.exercises.name}</p>
                        <p class="text-sm text-gray-400">${pe.sets} set x ${pe.reps} reps - ${pe.rest_period_seconds}s rest</p>
                        ${pe.exercises.video_url ? `<a href="${pe.exercises.video_url}" target="_blank" class="text-red-500 text-sm hover:underline">Guarda il video</a>` : ''}
                    </div>
                `;
            });

            daysHtml += `
                <div class="py-2">
                    <button class="w-full text-left day-toggle">
                        <h4 class="text-md font-bold text-gray-300">${day.name}</h4>
                    </button>
                    <div class="details-hidden pt-2">
                        ${exercisesHtml}
                    </div>
                </div>
            `;
        });

        programDiv.innerHTML = `
            <div class="p-4">
                <button class="w-full text-left program-toggle">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold">${program.name}</h3>
                            <p class="text-gray-400 text-sm">${program.description || ''}</p>
                        </div>
                        <span class="material-icons text-3xl text-red-500">play_circle</span>
                    </div>
                </button>
                <div class="details-hidden mt-4">
                    ${daysHtml}
                </div>
            </div>
        `;
        programContainer.appendChild(programDiv);
    }


    document.addEventListener('DOMContentLoaded', async () => {
        await checkSession();
        const program = await getAssignedWorkoutProgram();
        renderProgram(program);
    });

    // Event delegation for accordions
    programContainer.addEventListener('click', (e) => {
        const target = e.target.closest('.program-toggle, .day-toggle');
        if (target) {
            const details = target.nextElementSibling;
            if (details) {
                details.classList.toggle('details-hidden');
            }
        }
    });

</script>

</body></html>
