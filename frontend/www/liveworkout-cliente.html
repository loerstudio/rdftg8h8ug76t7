<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Workout Log - Fitness App</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<!-- Supabase and Auth Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./js/supabaseClient.js"></script>
<script src="./js/auth.js"></script>
<script src="./js/api.js"></script>
<style type="text/tailwindcss">
        :root {
            --primary-color: #EF4444;
            --background-color: #000000;
            --surface-color: #1F2937;
            --surface-color-2: #374151;
            --text-primary-color: #FFFFFF;
            --text-secondary-color: #9CA3AF;
            --text-accent-color: #F87171;
            --success-color: #4ADE80;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-primary-color);
            font-family: 'Inter', sans-serif;
        }
        .icon-btn {
            @apply bg-[var(--surface-color)] p-2 rounded-full;
        }
        .hidden {
            display: none;
        }
    </style>
<style>
        body {
          min-height: max(100dvh);
        }
    </style>
  </head>
<body class="pb-20">
<div class="flex flex-col h-full">
<header class="p-4 flex justify-between items-center sticky top-0 bg-black z-10">
<a class="text-white" href="schermata-liveworkout-scegligiorno-cliente.html">
<span class="material-icons">arrow_back_ios_new</span>
</a>
<h1 class="text-xl font-bold" id="exercise-name">Caricamento...</h1>
<button class="icon-btn">
<span class="material-icons">more_horiz</span>
</button>
</header>

<main id="workout-container" class="flex-grow p-4 space-y-6 hidden">
    <div class="relative" id="video-container">
        <!-- YouTube embed will go here -->
    </div>
    <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 rounded-full px-3 py-1 text-sm font-semibold" id="exercise-counter"></div>

    <!-- Timer Section -->
    <div id="timer-section" class="text-center space-y-2 hidden">
        <p class="text-sm text-[var(--text-secondary-color)]">Riposo</p>
        <p class="text-5xl font-bold" id="timer-display">00:00</p>
        <div class="flex justify-center space-x-2">
            <button id="skip-rest-button" class="bg-[var(--surface-color-2)] text-white font-semibold py-2 px-4 rounded-full">Salta Riposo</button>
        </div>
    </div>

    <!-- Log Set Form Section -->
    <div id="log-set-section" class="space-y-4">
        <div id="sets-list" class="space-y-2">
            <!-- Sets will be rendered here -->
        </div>
        <form id="log-set-form" class="p-4 bg-gray-800 rounded-lg space-y-3">
            <h3 id="current-set-title" class="text-lg font-semibold text-center"></h3>
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <label for="weight-input" class="text-sm text-gray-400">Peso (Kg)</label>
                    <input id="weight-input" type="number" step="0.5" class="w-full bg-gray-700 p-2 rounded text-center" placeholder="0">
                </div>
                <div class="flex-1">
                    <label for="reps-input" class="text-sm text-gray-400">Reps</label>
                    <input id="reps-input" type="number" class="w-full bg-gray-700 p-2 rounded text-center" placeholder="0">
                </div>
            </div>
            <button type="submit" class="w-full bg-[var(--primary-color)] text-white font-bold py-3 rounded-lg">Salva Serie e Riposa</button>
        </form>
    </div>
</main>

<footer id="footer-nav" class="p-4 sticky bottom-0 bg-black hidden">
    <div class="flex justify-between items-center">
        <button id="prev-exercise-button" class="flex items-center space-x-2 text-[var(--text-secondary-color)] disabled:opacity-50" disabled>
            <span class="material-icons">skip_previous</span>
            <span>Precedente</span>
        </button>
        <button id="next-exercise-button" class="flex items-center space-x-2 text-white disabled:opacity-50" disabled>
            <span>Prossimo</span>
            <span class="material-icons">skip_next</span>
        </button>
    </div>
</footer>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let workoutDay = null;
    let currentExerciseIndex = 0;
    let currentSetIndex = 0;
    let restTimer;
    let restTimeLeft = 0;

    // --- DOM ELEMENTS ---
    const exerciseNameEl = document.getElementById('exercise-name');
    const videoContainerEl = document.getElementById('video-container');
    const exerciseCounterEl = document.getElementById('exercise-counter');
    const timerSectionEl = document.getElementById('timer-section');
    const timerDisplayEl = document.getElementById('timer-display');
    const logSetSectionEl = document.getElementById('log-set-section');
    const setsListEl = document.getElementById('sets-list');
    const logSetFormEl = document.getElementById('log-set-form');
    const currentSetTitleEl = document.getElementById('current-set-title');
    const weightInputEl = document.getElementById('weight-input');
    const repsInputEl = document.getElementById('reps-input');
    const prevExerciseButton = document.getElementById('prev-exercise-button');
    const nextExerciseButton = document.getElementById('next-exercise-button');
    const skipRestButton = document.getElementById('skip-rest-button');
    const workoutContainerEl = document.getElementById('workout-container');
    const footerNavEl = document.getElementById('footer-nav');

    // --- UTILITY FUNCTIONS ---
    function getYoutubeEmbedUrl(url) {
        if (!url) return null;
        const videoId = url.split('v=')[1]?.split('&')[0];
        return videoId ? `https://www.youtube.com/embed/${videoId}` : null;
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
    }

    // --- RENDER FUNCTIONS ---
    function render() {
        if (!workoutDay) {
            workoutContainerEl.innerHTML = '<p class="text-center">Workout data not found.</p>';
            return;
        }
        workoutContainerEl.classList.remove('hidden');
        footerNavEl.classList.remove('hidden');

        const exercise = workoutDay.program_exercises[currentExerciseIndex].exercises;
        const programExercise = workoutDay.program_exercises[currentExerciseIndex];

        // Render header
        exerciseNameEl.textContent = exercise.name;
        exerciseCounterEl.textContent = `${currentExerciseIndex + 1}/${workoutDay.program_exercises.length}`;

        // Render video
        const embedUrl = getYoutubeEmbedUrl(exercise.video_url);
        if (embedUrl) {
            videoContainerEl.innerHTML = `<iframe class="w-full h-48 rounded-lg" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
        } else {
            videoContainerEl.innerHTML = `<div class="w-full h-48 rounded-lg bg-gray-800 flex items-center justify-center"><p>No video available</p></div>`;
        }

        // Render sets list
        setsListEl.innerHTML = '';
        for (let i = 0; i < programExercise.sets; i++) {
            const isCompleted = i < currentSetIndex;
            const isCurrent = i === currentSetIndex;
            setsListEl.innerHTML += `
                <div class="flex justify-between items-center ${isCurrent ? 'bg-gray-700' : 'bg-surface-color'} p-3 rounded-lg">
                    <span class="font-semibold">Serie ${i + 1}</span>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm">${programExercise.reps} Rep</span>
                        <span class="text-sm">${programExercise.notes || ''}</span>
                        <div class="w-6 h-6 rounded-full ${isCompleted ? 'bg-success-color' : 'border-2 border-text-secondary-color'} flex items-center justify-center">
                            ${isCompleted ? '<span class="material-icons text-black text-base">check</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Render form and timer visibility
        timerSectionEl.classList.add('hidden');
        logSetSectionEl.classList.remove('hidden');
        currentSetTitleEl.textContent = `Serie ${currentSetIndex + 1}`;

        // Render navigation buttons
        prevExerciseButton.disabled = currentExerciseIndex === 0;
        nextExerciseButton.disabled = currentExerciseIndex === workoutDay.program_exercises.length - 1;
    }

    // --- TIMER LOGIC ---
    function startRestTimer() {
        const restPeriod = workoutDay.program_exercises[currentExerciseIndex].rest_period_seconds;
        if (!restPeriod || restPeriod <= 0) {
            moveToNextSet();
            return;
        }

        restTimeLeft = restPeriod;
        logSetSectionEl.classList.add('hidden');
        timerSectionEl.classList.remove('hidden');
        timerDisplayEl.textContent = formatTime(restTimeLeft);

        restTimer = setInterval(() => {
            restTimeLeft--;
            timerDisplayEl.textContent = formatTime(restTimeLeft);
            if (restTimeLeft <= 0) {
                clearInterval(restTimer);
                moveToNextSet();
            }
        }, 1000);
    }

    function moveToNextSet() {
        clearInterval(restTimer);
        currentSetIndex++;
        const programExercise = workoutDay.program_exercises[currentExerciseIndex];
        if (currentSetIndex >= programExercise.sets) {
            // Move to next exercise if all sets are done
            if (currentExerciseIndex < workoutDay.program_exercises.length - 1) {
                currentExerciseIndex++;
                currentSetIndex = 0;
            } else {
                alert('Workout Complete!');
                window.location.href = 'schermata-liveworkout-scegligiorno-cliente.html';
                return;
            }
        }
        render();
    }


    // --- EVENT HANDLERS ---
    logSetFormEl.addEventListener('submit', async (e) => {
        e.preventDefault();
        const logData = {
            program_exercise_id: workoutDay.program_exercises[currentExerciseIndex].id,
            set_number: currentSetIndex + 1,
            reps_completed: parseInt(repsInputEl.value) || 0,
            weight_used: parseFloat(weightInputEl.value) || 0
        };

        const result = await logWorkoutSet(logData);
        if (result) {
            repsInputEl.value = '';
            weightInputEl.value = '';
            startRestTimer();
        }
    });

    skipRestButton.addEventListener('click', () => {
        moveToNextSet();
    });

    nextExerciseButton.addEventListener('click', () => {
        if (currentExerciseIndex < workoutDay.program_exercises.length - 1) {
            currentExerciseIndex++;
            currentSetIndex = 0;
            render();
        }
    });

    prevExerciseButton.addEventListener('click', () => {
        if (currentExerciseIndex > 0) {
            currentExerciseIndex--;
            currentSetIndex = 0;
            render();
        }
    });


    // --- INITIALIZATION ---
    async function init() {
        await checkSession();
        const urlParams = new URLSearchParams(window.location.search);
        const dayId = urlParams.get('dayId');
        if (!dayId) {
            alert('No workout day specified.');
            window.location.href = 'schermata-liveworkout-scegligiorno-cliente.html';
            return;
        }

        workoutDay = await getTrainingDay(dayId);
        render();
    }

    document.addEventListener('DOMContentLoaded', init);

</script>

</body></html>
